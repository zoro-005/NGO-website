{% extends "layout.html" %}
{% block body %}
  <!-- Hero Section -->
  <div class="block-31" style="position: relative;">
    <div class="owl-carousel loop-block-31">
      <div class="block-30 block-30-sm item" style="background-image: url('images/bg_1.jpg');" data-stellar-background-ratio="0.5">
        <div class="container">
          <div class="row align-items-center justify-content-center text-center">
            <div class="col-md-8">
              <h2 class="heading text-white text-4xl font-bold">Your Support Changes Lives</h2>
              <p class="lead text-white mt-3">Every donation helps us provide clean water, education, and shelter to those in need.</p>
              <button id="donate-now-btn" class="btn btn-primary mt-4 px-5 py-3" onclick="smoothScroll('#donate-section')">Donate Now</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Donation Section -->
  <div class="site-section fund-raisers py-5" id="donate-section">
    <div class="container">
      <div class="row mb-5 justify-content-center">
        <div class="col-md-8 text-center">
          <h2 class="text-3xl font-bold">Make a Difference Today</h2>
          <p class="lead mt-3">Your contribution fuels our mission. Choose an amount or set a custom donation to support our causes.</p>
        </div>
      </div>

      <!-- Donation Form -->
      <div class="row justify-content-center">
        <div class="col-md-6">
          <div class="card shadow-sm p-4">
            <h3 class="text-center mb-4">Donate Now</h3>
            <form id="donation-form" class="needs-validation" novalidate>
              <div class="form-group mb-3">
                <label for="donor-name" class="form-label">Full Name</label>
                <input type="text" class="form-control" id="donor-name" placeholder="Enter your name" required>
              </div>
              <div class="form-group mb-3">
                <label for="donor-email" class="form-label">Email Address</label>
                <input type="email" class="form-control" id="donor-email" placeholder="Enter your email" required>
              </div>
              <div class="form-group mb-3">
                <label class="form-label">Donation Amount</label>
                <div class="d-flex flex-wrap gap-2 mb-3">
                  <button type="button" class="btn btn-outline-primary donation-amount" data-amount="500">₹500</button>
                  <button type="button" class="btn btn-outline-primary donation-amount" data-amount="1000">₹1000</button>
                  <button type="button" class="btn btn-outline-primary donation-amount" data-amount="2000">₹2000</button>
                  <button type="button" class="btn btn-outline-primary donation-amount" data-amount="5000">₹5000</button>
                </div>
                <input type="number" class="form-control" id="custom-amount" placeholder="Or enter custom amount" min="1" required>
              </div>
              <button type="button" class="btn btn-primary w-100 py-3" onclick="initiateDonation()">Proceed to Payment</button>
            </form>
          </div>
        </div>
      </div>

      <!-- Latest Donations -->
      <div style="margin-top: 2rem;">
        <div style="text-align: center;">
          <h3 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1.5rem;">Recent Supporters</h3>
        </div>
        <div style="display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center;">
          {% for donor in donors %}
          <div style="flex: 1 1 250px; max-width: 250px; background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 1rem; text-align: center;">
            <h4 style="font-size: 1.125rem; font-weight: 600; margin: 0 0 0.5rem; white-space: normal;">{{ donor.name }}</h4>
            <span style="display: block; color: #6c757d; font-size: 0.875rem; margin-bottom: 0.5rem; white-space: normal;">Donated {{ donor.date.strftime('%b %d, %Y') }}</span>
            <p style="font-size: 1rem; margin: 0; white-space: normal;">Donated <span style="color: #28a745; font-weight: bold;">₹{{ donor.amount|int }}</span></p>
          </div>
          {% else %}
          <div style="text-align: center; width: 100%;">
            <p style="color: #6c757d; font-size: 1rem;">No recent donations yet. Be the first to support our cause!</p>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <!-- JavaScript -->
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <script>
    document.querySelectorAll('.donation-amount').forEach(button => {
      button.addEventListener('click', () => {
        document.querySelectorAll('.donation-amount').forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        document.getElementById('custom-amount').value = button.dataset.amount;
      });
    });

    // Form validation
    (function () {
      'use strict';
      const forms = document.querySelectorAll('.needs-validation');
      Array.from(forms).forEach(form => {
        form.addEventListener('submit', event => {
          event.preventDefault();
          event.stopPropagation();
          form.classList.add('was-validated');
        }, false);
      });
    })();

    function initiateDonation() {
      const form = document.getElementById('donation-form');
      if (!form.checkValidity()) {
        form.classList.add('was-validated');
        return;
      }

      const donorName = document.getElementById('donor-name').value;
      const donorEmail = document.getElementById('donor-email').value;
      const amount = document.getElementById('custom-amount').value;

      fetch('/process-donation', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          'donor-name': donorName,
          'donor-email': donorEmail,
          'custom-amount': amount
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.order_id) {
          openRazorpayCheckout(data.order_id, amount, donorName, donorEmail);
        } else {
          alert('Failed to create donation order: ' + (data.error || 'Unknown error'));
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while processing your donation.');
      });
    }

    function openRazorpayCheckout(orderId, amount, name, email) {
      const options = {
        "key": "{{ key_id }}",
        "amount": amount * 100,
        "currency": "INR",
        "name": "Your NGO Name",
        "description": "Donation",
        "image": "/static/images/ngo-logo.png",
        "order_id": orderId,
        "handler": function (response) {
          fetch('/verify-payment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              razorpay_payment_id: response.razorpay_payment_id,
              razorpay_order_id: response.razorpay_order_id,
              razorpay_signature: response.razorpay_signature
            })
          })
          .then(res => res.json())
          .then(data => {
            if (data.status === 'success') {
              window.location.href = data.redirect_url;
            } else {
              alert('Payment verification failed: ' + (data.error || 'Unknown error'));
            }
          })
          .catch(error => {
            console.error('Payment verification error:', error);
            alert('An error occurred during payment verification. Please try again.');
          });
        },
        "prefill": {
          "name": name,
          "email": email
        },
        "theme": {
          "color": "#f7ca44" // Updated to match site color
        }
      };
      const rzp = new Razorpay(options);
      rzp.on('payment.failed', function (response) {
        alert('Payment failed: ' + response.error.description);
      });
      rzp.open();
    }

    // Smooth scroll function
    function smoothScroll(target) {
      document.querySelector(target).scrollIntoView({ behavior: 'smooth' });
    }
  </script>
{% endblock %}